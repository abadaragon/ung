/*! JIO Storage - v0.1.0 - 2012-06-01
* Copyright (c) 2012 Nexedi; Licensed  */
(function(){var a=function(a,b,c,d){var e,f,g,h,i;e=function(b,d){var e=c.newBaseStorage(b,d),f={};return f.storage_user_array_name="jio/localuserarray",f.storage_file_array_name="jio/localfilenamearray/"+e.getStorageUserName()+"/"+e.getApplicantID(),f.getUserArray=function(){return a.getItem(f.storage_user_array_name)||[]},f.addUser=function(b){var c=f.getUserArray();c.push(b),a.setItem(f.storage_user_array_name,c)},f.getFileNameArray=function(){return a.getItem(f.storage_file_array_name)||[]},f.addFileName=function(b){var c=f.getFileNameArray();c.push(b),a.setItem(f.storage_file_array_name,c)},f.removeFileName=function(b){var c,d,e=f.getFileNameArray(),g=[];for(c=0,d=e.length;c<d;c+=1)e[c]!==b&&g.push(e[c]);a.setItem(f.storage_file_array_name,g)},e.checkNameAvailability=function(){setTimeout(function(){var a,b,c=f.getUserArray();for(a=0,b=c.length;a<b;a+=1)if(c[a]===e.getUserName()){e.done(!1);return}e.done(!0)},100)},e.saveDocument=function(){setTimeout(function(){var b=null,c="jio/local/"+e.getStorageUserName()+"/"+e.getApplicantID()+"/"+e.getFileName();return b=a.getItem(c),b?(b.lastModified=Date.now(),b.fileContent=e.getFileContent()):(b={fileName:e.getFileName(),fileContent:e.getFileContent(),creationDate:Date.now(),lastModified:Date.now()},f.addFileName(e.getFileName())),a.setItem(c,b),e.done()},100)},e.loadDocument=function(){setTimeout(function(){var b=null,c=e.cloneOptionObject();b=a.getItem("jio/local/"+e.getStorageUserName()+"/"+e.getApplicantID()+"/"+e.getFileName()),b?(c.metadata_only?delete b.fileContent:c.content_only&&(delete b.lastModified,delete b.creationDate),e.done(b)):e.fail({status:404,statusText:"Not Found.",message:'Document "'+e.getFileName()+'" not found in localStorage.'})},100)},e.getDocumentList=function(){setTimeout(function(){var b=[],c=[],d,g,h="key",i="jio/local/"+e.getStorageUserName()+"/"+e.getApplicantID(),j={};c=f.getFileNameArray();for(d=0,g=c.length;d<g;d+=1)j=a.getItem(i+"/"+c[d]),b.push({fileName:j.fileName,creationDate:j.creationDate,lastModified:j.lastModified});e.done(b)},100)},e.removeDocument=function(){setTimeout(function(){var b="jio/local/"+e.getStorageUserName()+"/"+e.getApplicantID()+"/"+e.getFileName();return a.deleteItem(b),f.removeFileName(e.getFileName()),e.done()},100)},e},f=function(a,e){var f=c.newBaseStorage(a,e);return f.mkcol=function(a){var c=d.extend({success:function(){},error:function(){}},a),e=["splitedpath"],g="temp/path";if(!c.pathsteps)c.pathsteps=1,f.mkcol(c);else{e=c.path.split("/");if(c.pathsteps>=e.length-1)return c.success();e.length=c.pathsteps+1,c.pathsteps++,g=e.join("/"),d.ajax({url:c.location+g,type:"MKCOL",async:!0,headers:{Authorization:"Basic "+b.encode(c.userName+":"+c.password),Depth:"1"},success:function(){f.mkcol(c)},error:function(a){c.error()}})}},f.checkNameAvailability=function(){d.ajax({url:f.getStorageLocation()+"/dav/"+f.getStorageUserName()+"/",async:!0,type:"PROPFIND",dataType:"xml",headers:{Authorization:"Basic "+b.encode(f.getStorageUserName()+":"+f.getStoragePassword()),Depth:"1"},success:function(a){f.done(!1)},error:function(a){a.status===404?f.done(!0):(a.message='Cannot check availability of "'+f.getUserName()+'" into DAVStorage.',f.fail(a))}})},f.saveDocument=function(){d.ajax({url:f.getStorageLocation()+"/dav/"+f.getStorageUserName()+"/"+f.getApplicantID()+"/"+f.getFileName(),type:"PUT",data:f.getFileContent(),async:!0,dataType:"text",headers:{Authorization:"Basic "+b.encode(f.getStorageUserName()+":"+f.getStoragePassword())},success:function(){f.done()},error:function(a){a.message='Cannot save "'+f.getFileName()+'" into DAVStorage.',f.fail(a)}})},f.loadDocument=function(){var a={},c=f.cloneOptionObject(),e=function(){d.ajax({url:f.getStorageLocation()+"/dav/"+f.getStorageUserName()+"/"+f.getApplicantID()+"/"+f.getFileName(),type:"GET",async:!0,dataType:"text",headers:{Authorization:"Basic "+b.encode(f.getStorageUserName()+":"+f.getStoragePassword())},success:function(b){a.fileContent=b,f.done(a)},error:function(a){a.status===404?a.message='Document "'+f.getFileName()+'" not found in localStorage.':a.message='Cannot load "'+f.getFileName()+'" from DAVStorage.',f.fail(a)}})};a.fileName=f.getFileName();if(c.content_only){e();return}d.ajax({url:f.getStorageLocation()+"/dav/"+f.getStorageUserName()+"/"+f.getApplicantID()+"/"+f.getFileName(),type:"PROPFIND",async:!0,dataType:"xml",headers:{Authorization:"Basic "+b.encode(f.getStorageUserName()+":"+f.getStoragePassword())},success:function(b){d(b).find("lp1\\:getlastmodified, getlastmodified").each(function(){a.lastModified=d(this).text()}),d(b).find("lp1\\:creationdate, creationdate").each(function(){a.creationDate=d(this).text()}),c.metadata_only?f.done(a):e()},error:function(a){a.message='Cannot load "'+f.getFileName()+'" informations from DAVStorage.',f.fail(a)}})},f.getDocumentList=function(){var a=[],c={},e=[];d.ajax({url:f.getStorageLocation()+"/dav/"+f.getStorageUserName()+"/"+f.getApplicantID()+"/",async:!0,type:"PROPFIND",dataType:"xml",headers:{Authorization:"Basic "+b.encode(f.getStorageUserName()+":"+f.getStoragePassword()),Depth:"1"},success:function(b){d(b).find("D\\:response, response").each(function(b,f){if(b>0){c={},d(f).find("D\\:href, href").each(function(){e=d(this).text().split("/"),c.fileName=e[e.length-1]?e[e.length-1]:e[e.length-2]+"/"});if(c.fileName===".htaccess"||c.fileName===".htpasswd")return;d(f).find("lp1\\:getlastmodified, getlastmodified").each(function(){c.lastModified=d(this).text()}),d(f).find("lp1\\:creationdate, creationdate").each(function(){c.creationDate=d(this).text()}),a.push(c)}}),f.done(a)},error:function(a){a.message="Cannot get a document list from DAVStorage.",f.fail(a)}})},f.removeDocument=function(){d.ajax({url:f.getStorageLocation()+"/dav/"+f.getStorageUserName()+"/"+f.getApplicantID()+"/"+f.getFileName(),type:"DELETE",async:!0,headers:{Authorization:"Basic "+b.encode(f.getStorageUserName()+":"+f.getStoragePassword())},success:function(){f.done()},error:function(a){a.status===404?f.done():(a.message='Cannot remove "'+f.getFileName()+'" from DAVStorage.',f.fail(a))}})},f},g=function(a,b){var d=c.newBaseStorage(a,b),e={};return e.storageArray=d.getStorageArray(),e.length=e.storageArray.length,e.returnsValuesArray=[],e.maxtries=d.getMaxTries(),d.setMaxTries(1),e.execJobsFromStorageArray=function(a){var b={},c;for(c=0;c<e.storageArray.length;c+=1)b=d.cloneJob(),b.maxtries=e.maxtries,b.storage=e.storageArray[c],b.callback=a,d.addJob(b)},d.checkNameAvailability=function(){var a="id",b=!1,c=[],f={status:"done"},g=function(a){e.returnsValuesArray.push(a);if(!b){if(a.status==="fail")f.status="fail",c.push(a.error);else if(a.return_value===!1){d.done(!1),b=!0;return}if(e.returnsValuesArray.length===e.length){f.status==="fail"?d.fail({status:207,statusText:"Multi-Status",message:'Some check availability of "'+d.getUserName()+'" requests have failed.',array:c}):d.done(!0),b=!0;return}}};e.execJobsFromStorageArray(g)},d.saveDocument=function(){var a={status:"done"},b="id",c=!1,f=[],g=function(a){e.returnsValuesArray.push(a),c||(a.status!=="fail"?(d.done(),c=!0):(f.push(a.error),e.returnsValuesArray.length===e.length&&d.fail({status:207,statusText:"Multi-Status",message:'All save "'+d.getFileName()+'" requests have failed.',array:f})))};e.execJobsFromStorageArray(g)},d.loadDocument=function(){var a={},b="id",c=!1,f=[],g={status:"done"},h=function(a){e.returnsValuesArray.push(a),c||(a.status!=="fail"?(d.done(a.return_value),c=!0):(f.push(a.error),e.returnsValuesArray.length===e.length&&d.fail({status:207,statusText:"Multi-Status",message:'All load "'+d.getFileName()+'" requests have failed.',array:f})))};e.execJobsFromStorageArray(h)},d.getDocumentList=function(){var a={status:"done"},b="id",c=!1,f=[],g=function(a){e.returnsValuesArray.push(a),c||(a.status!=="fail"?(d.done(a.return_value),c=!0):(f.push(a.error),e.returnsValuesArray.length===e.length&&d.fail({status:207,statusText:"Multi-Status",message:"All get document list requests have failed",array:f})))};e.execJobsFromStorageArray(g)},d.removeDocument=function(){var a={status:"done"},b="key",c=!1,f=[],g=function(a){e.returnsValuesArray.push(a),c||(a.status!=="fail"?(d.done(),c=!0):(f.push(a.error),e.returnsValuesArray.length===e.length&&d.fail({status:207,statusText:"Multi-Status",message:'All remove "'+d.getFileName()+'" requests have failed.',array:f})))};e.execJobsFromStorageArray(g)},d},h=function(b,d){var e=c.newBaseStorage(b,d),f={};return f.storage_array_name="jio/indexedstoragearray",f.storage_file_array_name="jio/indexedfilearray/"+JSON.stringify(e.getSecondStorage())+"/"+e.getApplicantID(),f.indexedStorageArrayExists=function(){return a.getItem(f.storage_array_name)?!0:!1},f.getIndexedStorageArray=function(){return a.getItem(f.storage_array_name)||[]},f.addIndexedStorage=function(b){var c=f.getIndexedStorageArray();c.push(JSON.stringify(b)),a.setItem(f.storage_array_name,c)},f.isAnIndexedStorage=function(a){var b=JSON.stringify(a),c,d,e=f.getIndexedStorageArray();for(c=0,d=e.length;c<d;c+=1)if(JSON.stringify(e[c])===b)return!0;return!1},f.fileArrayExists=function(){return a.getItem(f.storage_file_array_name)?!0:!1},f.getFileArray=function(){return a.getItem(f.storage_file_array_name)||[]},f.setFileArray=function(b){return a.setItem(f.storage_file_array_name,b)},f.isFileIndexed=function(a){var b,c,d=f.getFileArray();for(b=0,c=d.length;b<c;b+=1)if(d[b].fileName===a)return!0;return!1},f.addFile=function(b){var c=f.getFileArray();c.push(b),a.setItem(f.storage_file_array_name,c)},f.removeFile=function(b){var c,d,e=f.getFileArray(),g=[];for(c=0,d=e.length;c<d;c+=1)e[c].fileName!==b&&g.push(e[c]);a.setItem(f.storage_file_array_name,g)},f.update=function(a){var b=function(a){a.status==="done"&&(f.isAnIndexedStorage(e.getSecondStorage())||f.addIndexedStorage(e.getSecondStorage()),f.setFileArray(a.return_value))},c={storage:e.getSecondStorage(),applicant:{ID:e.getApplicantID()},method:"getDocumentList",maxtries:3,callback:b};e.addJob(c)},e.checkNameAvailability=function(){var a=e.cloneJob();f.update(),a.storage=e.getSecondStorage(),a.callback=function(a){a.status==="done"?e.done(a.return_value):e.fail(a.error)},e.addJob(a)},e.saveDocument=function(){var a=e.cloneJob();a.storage=e.getSecondStorage(),a.callback=function(a){a.status==="done"?(f.isFileIndexed(e.getFileName())||f.addFile({fileName:e.getFileName(),lastModified:0,creationDate:0}),f.update(),e.done()):e.fail(a.error)},e.addJob(a)},e.loadDocument=function(){var a,b,c,d,g=function(a){a.status==="done"?e.done(a.return_value):e.fail(a.error)},h=function(){d=e.cloneJob(),d.storage=e.getSecondStorage(),d.callback=g,console.log(d),e.addJob(d)},i=e.cloneOptionObject();f.update(),i.metadata_only?setTimeout(function(){if(f.fileArrayExists()){a=f.getFileArray();for(b=0,c=a.length;b<c;b+=1)if(a[b].fileName===e.getFileName())return e.done(a[b])}else h()},100):h()},e.getDocumentList=function(){var a;f.update(),a=setInterval(function(){f.fileArrayExists()&&(e.done(f.getFileArray()),clearInterval(a))},100)},e.removeDocument=function(){var a=e.cloneJob();a.storage=e.getSecondStorage(),a.callback=function(a){a.status==="done"?(f.removeFile(e.getFileName()),f.update(),e.done()):e.fail(a.error)},e.addJob(a)},e},c.addStorageType("local",e),c.addStorageType("dav",f),c.addStorageType("replicate",g),c.addStorageType("indexed",h)};window.requirejs?define("JIOStorages",["LocalOrCookieStorage","Base64","JIO","jQuery"],a):a(LocalOrCookieStorage,Base64,JIO,jQuery)})();