/*! JIO Storage - v0.1.0 - 2012-06-05
* Copyright (c) 2012 Nexedi; Licensed  */
(function(){var a=function(a,b,c,d,e){var f,g,h,i,j;f=function(b,c){var d=e.newBaseStorage(b,c),f={};return f.storage_user_array_name="jio/local_user_array",f.storage_file_array_name="jio/local_file_name_array/"+d.getStorageUserName()+"/"+d.getApplicantID(),f.getUserArray=function(){return a.getItem(f.storage_user_array_name)||[]},f.addUser=function(b){var c=f.getUserArray();c.push(b),a.setItem(f.storage_user_array_name,c)},f.userExists=function(a){var b=f.getUserArray(),c,d;for(c=0,d=b.length;c<d;c+=1)if(b[c]===a)return!0;return!1},f.getFileNameArray=function(){return a.getItem(f.storage_file_array_name)||[]},f.addFileName=function(b){var c=f.getFileNameArray();c.push(b),a.setItem(f.storage_file_array_name,c)},f.removeFileName=function(b){var c,d,e=f.getFileNameArray(),g=[];for(c=0,d=e.length;c<d;c+=1)e[c]!==b&&g.push(e[c]);a.setItem(f.storage_file_array_name,g)},d.checkNameAvailability=function(){setTimeout(function(){d.done(!f.userExists(d.getUserName()))},100)},d.saveDocument=function(){setTimeout(function(){var b=null,c="jio/local/"+d.getStorageUserName()+"/"+d.getApplicantID()+"/"+d.getFileName();return b=a.getItem(c),b?(b.last_modified=Date.now(),b.content=d.getFileContent()):(b={name:d.getFileName(),content:d.getFileContent(),creation_date:Date.now(),last_modified:Date.now()},f.userExists(d.getStorageUserName())||f.addUser(d.getStorageUserName()),f.addFileName(d.getFileName())),a.setItem(c,b),d.done()},100)},d.loadDocument=function(){setTimeout(function(){var b=null,c=d.cloneOptionObject();b=a.getItem("jio/local/"+d.getStorageUserName()+"/"+d.getApplicantID()+"/"+d.getFileName()),b?(c.metadata_only?delete b.content:c.content_only&&(delete b.last_modified,delete b.creation_date),d.done(b)):d.fail({status:404,statusText:"Not Found.",message:'Document "'+d.getFileName()+'" not found in localStorage.'})},100)},d.getDocumentList=function(){setTimeout(function(){var b=[],c=[],e,g,h="key",i="jio/local/"+d.getStorageUserName()+"/"+d.getApplicantID(),j={};c=f.getFileNameArray();for(e=0,g=c.length;e<g;e+=1)j=a.getItem(i+"/"+c[e]),j&&b.push({name:j.name,creation_date:j.creation_date,last_modified:j.last_modified});d.done(b)},100)},d.removeDocument=function(){setTimeout(function(){var b="jio/local/"+d.getStorageUserName()+"/"+d.getApplicantID()+"/"+d.getFileName();return a.deleteItem(b),f.removeFileName(d.getFileName()),d.done()},100)},d},g=function(a,d){var f=e.newBaseStorage(a,d);return f.mkcol=function(a){var d=b.extend({success:function(){},error:function(){}},a),e=["split_path"],g="temp/path";if(!d.pathsteps)d.pathsteps=1,f.mkcol(d);else{e=d.path.split("/");if(d.pathsteps>=e.length-1)return d.success();e.length=d.pathsteps+1,d.pathsteps++,g=e.join("/"),b.ajax({url:d.url+g,type:"MKCOL",async:!0,headers:{Authorization:"Basic "+c.encode(d.user_name+":"+d.password),Depth:"1"},success:function(){f.mkcol(d)},error:function(a){d.error()}})}},f.checkNameAvailability=function(){b.ajax({url:f.getStorageURL()+"/dav/"+f.getStorageUserName()+"/",async:!0,type:"PROPFIND",dataType:"xml",headers:{Authorization:"Basic "+c.encode(f.getStorageUserName()+":"+f.getStoragePassword()),Depth:"1"},success:function(a){f.done(!1)},error:function(a){a.status===404?f.done(!0):(a.message='Cannot check availability of "'+f.getUserName()+'" into DAVStorage.',f.fail(a))}})},f.saveDocument=function(){b.ajax({url:f.getStorageURL()+"/dav/"+f.getStorageUserName()+"/"+f.getApplicantID()+"/"+f.getFileName(),type:"PUT",data:f.getFileContent(),async:!0,dataType:"text",headers:{Authorization:"Basic "+c.encode(f.getStorageUserName()+":"+f.getStoragePassword())},success:function(){f.done()},error:function(a){a.message='Cannot save "'+f.getFileName()+'" into DAVStorage.',f.fail(a)}})},f.loadDocument=function(){var a={},d=f.cloneOptionObject(),e=function(){b.ajax({url:f.getStorageURL()+"/dav/"+f.getStorageUserName()+"/"+f.getApplicantID()+"/"+f.getFileName(),type:"GET",async:!0,dataType:"text",headers:{Authorization:"Basic "+c.encode(f.getStorageUserName()+":"+f.getStoragePassword())},success:function(b){a.content=b,f.done(a)},error:function(a){a.status===404?a.message='Document "'+f.getFileName()+'" not found in localStorage.':a.message='Cannot load "'+f.getFileName()+'" from DAVStorage.',f.fail(a)}})};a.name=f.getFileName();if(d.content_only){e();return}b.ajax({url:f.getStorageURL()+"/dav/"+f.getStorageUserName()+"/"+f.getApplicantID()+"/"+f.getFileName(),type:"PROPFIND",async:!0,dataType:"xml",headers:{Authorization:"Basic "+c.encode(f.getStorageUserName()+":"+f.getStoragePassword())},success:function(c){b(c).find("lp1\\:getlastmodified, getlastmodified").each(function(){a.last_modified=b(this).text()}),b(c).find("lp1\\:creationdate, creationdate").each(function(){a.creation_date=b(this).text()}),d.metadata_only?f.done(a):e()},error:function(a){a.message='Cannot load "'+f.getFileName()+'" informations from DAVStorage.',f.fail(a)}})},f.getDocumentList=function(){var a=[],d={},e=[];b.ajax({url:f.getStorageURL()+"/dav/"+f.getStorageUserName()+"/"+f.getApplicantID()+"/",async:!0,type:"PROPFIND",dataType:"xml",headers:{Authorization:"Basic "+c.encode(f.getStorageUserName()+":"+f.getStoragePassword()),Depth:"1"},success:function(c){b(c).find("D\\:response, response").each(function(c,f){if(c>0){d={},b(f).find("D\\:href, href").each(function(){e=b(this).text().split("/"),d.name=e[e.length-1]?e[e.length-1]:e[e.length-2]+"/"});if(d.name===".htaccess"||d.name===".htpasswd")return;b(f).find("lp1\\:getlastmodified, getlastmodified").each(function(){d.last_modified=b(this).text()}),b(f).find("lp1\\:creationdate, creationdate").each(function(){d.creation_date=b(this).text()}),a.push(d)}}),f.done(a)},error:function(a){a.message="Cannot get a document list from DAVStorage.",f.fail(a)}})},f.removeDocument=function(){b.ajax({url:f.getStorageURL()+"/dav/"+f.getStorageUserName()+"/"+f.getApplicantID()+"/"+f.getFileName(),type:"DELETE",async:!0,headers:{Authorization:"Basic "+c.encode(f.getStorageUserName()+":"+f.getStoragePassword())},success:function(){f.done()},error:function(a){a.status===404?f.done():(a.message='Cannot remove "'+f.getFileName()+'" from DAVStorage.',f.fail(a))}})},f},h=function(a,b){var c=e.newBaseStorage(a,b),d={};return d.storageArray=c.getStorageArray(),d.length=d.storageArray.length,d.return_value_array=[],d.max_tries=c.getMaxTries(),c.setMaxTries(1),d.execJobsFromStorageArray=function(a){var b={},e;for(e=0;e<d.storageArray.length;e+=1)b=c.cloneJob(),b.max_tries=d.max_tries,b.storage=d.storageArray[e],b.callback=a,c.addJob(b)},c.checkNameAvailability=function(){var a="id",b=!1,e=[],f={status:"done"},g=function(a){d.return_value_array.push(a);if(!b){if(a.status==="fail")f.status="fail",e.push(a.error);else if(a.return_value===!1){c.done(!1),b=!0;return}if(d.return_value_array.length===d.length){f.status==="fail"?c.fail({status:207,statusText:"Multi-Status",message:'Some check availability of "'+c.getUserName()+'" requests have failed.',array:e}):c.done(!0),b=!0;return}}};d.execJobsFromStorageArray(g)},c.saveDocument=function(){var a={status:"done"},b="id",e=!1,f=[],g=function(a){d.return_value_array.push(a),e||(a.status!=="fail"?(c.done(),e=!0):(f.push(a.error),d.return_value_array.length===d.length&&c.fail({status:207,statusText:"Multi-Status",message:'All save "'+c.getFileName()+'" requests have failed.',array:f})))};d.execJobsFromStorageArray(g)},c.loadDocument=function(){var a={},b="id",e=!1,f=[],g={status:"done"},h=function(a){d.return_value_array.push(a),e||(a.status!=="fail"?(c.done(a.return_value),e=!0):(f.push(a.error),d.return_value_array.length===d.length&&c.fail({status:207,statusText:"Multi-Status",message:'All load "'+c.getFileName()+'" requests have failed.',array:f})))};d.execJobsFromStorageArray(h)},c.getDocumentList=function(){var a={status:"done"},b="id",e=!1,f=[],g=function(a){d.return_value_array.push(a),e||(a.status!=="fail"?(c.done(a.return_value),e=!0):(f.push(a.error),d.return_value_array.length===d.length&&c.fail({status:207,statusText:"Multi-Status",message:"All get document list requests have failed",array:f})))};d.execJobsFromStorageArray(g)},c.removeDocument=function(){var a={status:"done"},b="key",e=!1,f=[],g=function(a){d.return_value_array.push(a),e||(a.status!=="fail"?(c.done(),e=!0):(f.push(a.error),d.return_value_array.length===d.length&&c.fail({status:207,statusText:"Multi-Status",message:'All remove "'+c.getFileName()+'" requests have failed.',array:f})))};d.execJobsFromStorageArray(g)},c},i=function(b,c){var d=e.newBaseStorage(b,c),f={};return f.storage_array_name="jio/indexed_storage_array",f.storage_file_array_name="jio/indexed_file_array/"+JSON.stringify(d.getSecondStorage())+"/"+d.getApplicantID(),f.indexedStorageArrayExists=function(){return a.getItem(f.storage_array_name)?!0:!1},f.getIndexedStorageArray=function(){return a.getItem(f.storage_array_name)||[]},f.addIndexedStorage=function(b){var c=f.getIndexedStorageArray();c.push(JSON.stringify(b)),a.setItem(f.storage_array_name,c)},f.isAnIndexedStorage=function(a){var b=JSON.stringify(a),c,d,e=f.getIndexedStorageArray();for(c=0,d=e.length;c<d;c+=1)if(JSON.stringify(e[c])===b)return!0;return!1},f.fileArrayExists=function(){return a.getItem(f.storage_file_array_name)?!0:!1},f.getFileArray=function(){return a.getItem(f.storage_file_array_name)||[]},f.setFileArray=function(b){return a.setItem(f.storage_file_array_name,b)},f.isFileIndexed=function(a){var b,c,d=f.getFileArray();for(b=0,c=d.length;b<c;b+=1)if(d[b].name===a)return!0;return!1},f.addFile=function(b){var c=f.getFileArray();c.push(b),a.setItem(f.storage_file_array_name,c)},f.removeFile=function(b){var c,d,e=f.getFileArray(),g=[];for(c=0,d=e.length;c<d;c+=1)e[c].name!==b&&g.push(e[c]);a.setItem(f.storage_file_array_name,g)},f.update=function(a){var b=function(a){a.status==="done"&&(f.isAnIndexedStorage(d.getSecondStorage())||f.addIndexedStorage(d.getSecondStorage()),f.setFileArray(a.return_value))},c={storage:d.getSecondStorage(),applicant:{ID:d.getApplicantID()},method:"getDocumentList",max_tries:3,callback:b};d.addJob(c)},d.checkNameAvailability=function(){var a=d.cloneJob();f.update(),a.storage=d.getSecondStorage(),a.callback=function(a){a.status==="done"?d.done(a.return_value):d.fail(a.error)},d.addJob(a)},d.saveDocument=function(){var a=d.cloneJob();a.storage=d.getSecondStorage(),a.callback=function(a){a.status==="done"?(f.isFileIndexed(d.getFileName())||f.addFile({name:d.getFileName(),last_modified:0,creation_date:0}),f.update(),d.done()):d.fail(a.error)},d.addJob(a)},d.loadDocument=function(){var a,b,c,e,g=function(a){a.status==="done"?d.done(a.return_value):d.fail(a.error)},h=function(){e=d.cloneJob(),e.storage=d.getSecondStorage(),e.callback=g,d.addJob(e)},i=d.cloneOptionObject();f.update(),i.metadata_only?setTimeout(function(){if(f.fileArrayExists()){a=f.getFileArray();for(b=0,c=a.length;b<c;b+=1)if(a[b].name===d.getFileName())return d.done(a[b])}else h()},100):h()},d.getDocumentList=function(){var a;f.update(),a=setInterval(function(){f.fileArrayExists()&&(d.done(f.getFileArray()),clearInterval(a))},100)},d.removeDocument=function(){var a=d.cloneJob();a.storage=d.getSecondStorage(),a.callback=function(a){a.status==="done"?(f.removeFile(d.getFileName()),f.update(),d.done()):d.fail(a.error)},d.addJob(a)},d},j=function(a,c){var f=e.newBaseStorage(a,c),g={};return g.encrypt_param_object={iv:"kaprWwY/Ucr7pumXoTHbpA",v:1,iter:1e3,ks:256,ts:128,mode:"ccm",adata:"",cipher:"aes",salt:"K4bmZG9d704"},g.decrypt_param_object={iv:"kaprWwY/Ucr7pumXoTHbpA",ks:256,ts:128,salt:"K4bmZG9d704"},g.encrypt=function(a,b,c){var e=d.encrypt(f.getStorageUserName()+":"+f.getStoragePassword(),a,g.encrypt_param_object);b(JSON.parse(e).ct,c)},g.decrypt=function(a,c,e,h){var i,j=b.extend(!0,{},g.decrypt_param_object);j.ct=a||"",j=JSON.stringify(j);try{i=d.decrypt(f.getStorageUserName()+":"+f.getStoragePassword(),j)}catch(k){c({status:0,statusText:"Decrypt Fail",message:"Unable to decrypt."},e,h);return}c(i,e,h)},f.checkNameAvailability=function(){var a=f.cloneJob();a.storage=f.getSecondStorage(),a.callback=function(a){a.status==="done"?f.done(a.return_value):f.fail(a.error)},f.addJob(a)},f.saveDocument=function(){var a,b,c,d=function(){g.encrypt(f.getFileName(),function(a){b=a,e()})},e=function(){g.encrypt(f.getFileContent(),function(a){c=a,h()})},h=function(){a=f.cloneJob(),a.name=b,a.content=c,a.storage=f.getSecondStorage(),a.callback=function(a){a.status==="done"?f.done():f.fail(a.error)},f.addJob(a)};d()},f.loadDocument=function(){var a,b,c=f.cloneOptionObject(),d=function(){g.encrypt(f.getFileName(),function(a){b=a,e()})},e=function(){a=f.cloneJob(),a.name=b,a.storage=f.getSecondStorage(),a.callback=h,f.addJob(a)},h=function(a){a.status==="done"?(a.return_value.name=f.getFileName(),c.metadata_only?f.done(a.return_value):g.decrypt(a.return_value.content,function(b){typeof b=="object"?f.fail({status:0,statusText:"Decrypt Fail",message:"Unable to decrypt"}):(a.return_value.content=b,f.done(a.return_value))})):f.fail(a.error)};d()},f.getDocumentList=function(){var a,b,c,d=0,e,h=!0,i=function(){a=f.cloneJob(),a.storage=f.getSecondStorage(),a.callback=j,f.addJob(a)},j=function(a){if(a.status==="done"){e=a.return_value;for(b=0,c=e.length;b<c;b+=1)g.decrypt(e[b].name,k,b,"name")}else f.fail(a.error)},k=function(a,b,g){var i;d++;if(typeof a=="object"){h&&f.fail({status:0,statusText:"Decrypt Fail",message:"Unable to decrypt."}),h=!1;return}e[b][g]=a,d===c&&h&&f.done(e)};i()},f.removeDocument=function(){var a,b,c=function(){g.encrypt(f.getFileName(),function(a){b=a,d()})},d=function(){a=f.cloneJob(),a.name=b,a.storage=f.getSecondStorage(),a.callback=e,f.addJob(a)},e=function(a){a.status==="done"?f.done():f.fail(a.error)};c()},f},e.addStorageType("local",f),e.addStorageType("dav",g),e.addStorageType("replicate",h),e.addStorageType("indexed",i),e.addStorageType("crypted",j)};window.requirejs?define("JIOStorages",["LocalOrCookieStorage","jQuery","Base64","SJCL","JIO"],a):a(LocalOrCookieStorage,jQuery,Base64,sjcl,JIO)})();