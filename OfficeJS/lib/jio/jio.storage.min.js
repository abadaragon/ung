/*! JIO Storage - v0.1.0 - 2012-05-23
* Copyright (c) 2012 Nexedi; Licensed  */
(function(){var a=function(a,b,c,d){var e=function(){var a=!0,c=function(b){console.error("Fail to load "+b),a=!1};try{b||c("Base64")}catch(d){c("Base64")}return a},f,g,h;f=function(b){var e=c.newBaseStorage(b),f={};return e.checkNameAvailability=function(){setTimeout(function(){var b=null,c,d;b=a.getAll();for(c in b){d=c.split("/");if(d[0]==="jio"&&d[1]==="local"&&d[2]===e.getUserName())return e.done(!1)}return e.done(!0)},100)},e.saveDocument=function(){setTimeout(function(){var b=null;return b=a.getItem("jio/local/"+e.getStorageUserName()+"/"+e.getApplicantID()+"/"+e.getFileName()),b?(b.lastModified=Date.now(),b.fileContent=e.getFileContent()):b={fileName:e.getFileName(),fileContent:e.getFileContent(),creationDate:Date.now(),lastModified:Date.now()},a.setItem("jio/local/"+e.getStorageUserName()+"/"+e.getApplicantID()+"/"+e.getFileName(),b),e.done()},100)},e.loadDocument=function(){setTimeout(function(){var b=null,c=d.extend({getContent:!0},e.cloneOptionObject());b=a.getItem("jio/local/"+e.getStorageUserName()+"/"+e.getApplicantID()+"/"+e.getFileName()),b?(c.getContent||delete b.fileContent,e.done(b)):e.fail("Document not found.",404)},100)},e.getDocumentList=function(){setTimeout(function(){var b=[],c=null,d="key",f=["splitedkey"],g={};c=a.getAll();for(d in c)f=d.split("/"),f[0]==="jio"&&f[1]==="local"&&f[2]===e.getStorageUserName()&&f[3]===e.getApplicantID()&&(g=JSON.parse(c[d]),b.push({fileName:g.fileName,creationDate:g.creationDate,lastModified:g.lastModified}));e.done(b)},100)},e.removeDocument=function(){setTimeout(function(){return a.deleteItem("jio/local/"+e.getStorageUserName()+"/"+e.getApplicantID()+"/"+e.getFileName()),e.done()},100)},e},g=function(a){var e=c.newBaseStorage(a);return e.mkcol=function(a){var c=d.extend({success:function(){},error:function(){}},a),f=["splitedpath"],g="temp/path";if(!c.pathsteps)c.pathsteps=1,e.mkcol(c);else{f=c.path.split("/");if(c.pathsteps>=f.length-1)return c.success();f.length=c.pathsteps+1,c.pathsteps++,g=f.join("/"),d.ajax({url:c.location+g,type:"MKCOL",async:!0,headers:{Authorization:"Basic "+b.encode(c.userName+":"+c.password),Depth:"1"},success:function(){e.mkcol(c)},error:function(a){c.error()}})}},e.checkNameAvailability=function(){d.ajax({url:e.getStorageLocation()+"/dav/"+e.getStorageUserName()+"/",async:!0,type:"PROPFIND",dataType:"xml",headers:{Authorization:"Basic "+b.encode(e.getStorageUserName()+":"+e.getStoragePassword()),Depth:"1"},success:function(a){e.done(!1)},error:function(a){a.status===404?e.done(!0):e.fail("Cannot check if "+e.getUserName()+" is available.",a.status)}})},e.saveDocument=function(){d.ajax({url:e.getStorageLocation()+"/dav/"+e.getStorageUserName()+"/"+e.getApplicantID()+"/"+e.getFileName(),type:"PUT",data:e.getFileContent(),async:!0,dataType:"text",headers:{Authorization:"Basic "+b.encode(e.getStorageUserName()+":"+e.getStoragePassword())},success:function(){e.done()},error:function(a){e.fail("Cannot save document.",a.status)}})},e.loadDocument=function(){var a={},c=d.extend({getContent:!0},e.cloneOptionObject()),f=function(){d.ajax({url:e.getStorageLocation()+"/dav/"+e.getStorageUserName()+"/"+e.getApplicantID()+"/"+e.getFileName(),type:"GET",async:!0,dataType:"text",headers:{Authorization:"Basic "+b.encode(e.getStorageUserName()+":"+e.getStoragePassword())},success:function(b){a.fileContent=b,e.done(a)},error:function(a){var b;a.status===404?b="Document not found.":b='Cannot load "'+e.getFileName()+'".',e.fail(b,a.status)}})};d.ajax({url:e.getStorageLocation()+"/dav/"+e.getStorageUserName()+"/"+e.getApplicantID()+"/"+e.getFileName(),type:"PROPFIND",async:!0,dataType:"xml",headers:{Authorization:"Basic "+b.encode(e.getStorageUserName()+":"+e.getStoragePassword())},success:function(b){d(b).find("lp1\\:getlastmodified, getlastmodified").each(function(){a.lastModified=d(this).text()}),d(b).find("lp1\\:creationdate, creationdate").each(function(){a.creationDate=d(this).text()}),a.fileName=e.getFileName(),c.getContent?f():e.done(a)},error:function(a){e.fail("Cannot get document informations.",a.status)}})},e.getDocumentList=function(){var a=[],c={},f=[];d.ajax({url:e.getStorageLocation()+"/dav/"+e.getStorageUserName()+"/"+e.getApplicantID()+"/",async:!0,type:"PROPFIND",dataType:"xml",headers:{Authorization:"Basic "+b.encode(e.getStorageUserName()+":"+e.getStoragePassword()),Depth:"1"},success:function(b){d(b).find("D\\:response, response").each(function(b,e){if(b>0){c={},d(e).find("D\\:href, href").each(function(){f=d(this).text().split("/"),c.fileName=f[f.length-1]?f[f.length-1]:f[f.length-2]+"/"});if(c.fileName===".htaccess"||c.fileName===".htpasswd")return;d(e).find("lp1\\:getlastmodified, getlastmodified").each(function(){c.lastModified=d(this).text()}),d(e).find("lp1\\:creationdate, creationdate").each(function(){c.creationDate=d(this).text()}),a.push(c)}}),e.done(a)},error:function(a){e.fail("Cannot get list.",a.status)}})},e.removeDocument=function(){d.ajax({url:e.getStorageLocation()+"/dav/"+e.getStorageUserName()+"/"+e.getApplicantID()+"/"+e.getFileName(),type:"DELETE",async:!0,headers:{Authorization:"Basic "+b.encode(e.getStorageUserName()+":"+e.getStoragePassword())},success:function(){e.done()},error:function(a){a.status===404?e.done():e.fail('Cannot remove "'+e.getFileName()+'".',a.status)}})},e},h=function(a){var b=c.newBaseStorage(a),d={};return d.storageArray=b.getStorageArray(),d.length=d.storageArray.length,d.returnsValuesArray=[],d.maxtries=b.getMaxTries(),b.setMaxTries(1),d.execJobsFromStorageArray=function(a){var c={},e;for(e=0;e<d.storageArray.length;e+=1)c=b.cloneJob(),c.maxtries=d.maxtries,c.storage=d.storageArray[e],c.callback=a,b.addJob(c)},b.checkNameAvailability=function(){var a={},c="id",e=!1,f={status:"done"},g=function(a){d.returnsValuesArray.push(a);if(!e){if(a.status==="fail")f.status="fail";else if(a.return_value===!1){b.done(!1),e=!0;return}if(d.returnsValuesArray.length===d.length){f.status==="fail"?b.fail("Unable to check name availability.",0):b.done(!0),e=!0;return}}};d.execJobsFromStorageArray(g)},b.saveDocument=function(){var a={},c={status:"done"},e="id",f=!1,g=function(a){d.returnsValuesArray.push(a),f||(a.status!=="fail"?(b.done(),f=!0):d.returnsValuesArray.length===d.length&&b.fail("Unable to save any file.",0))};d.execJobsFromStorageArray(g)},b.loadDocument=function(){var a={},c=!1,e={},f="id",g=!1,h={status:"done"},i=function(a){d.returnsValuesArray.push(a),g||(a.status!=="fail"?(b.done(a.return_value),g=!0):d.returnsValuesArray.length===d.length&&b.fail("Unable to load any file.",0))};d.execJobsFromStorageArray(i)},b.getDocumentList=function(){var a={},c={status:"done"},e="id",f=!1,g=function(a){d.returnsValuesArray.push(a),f||(a.status!=="fail"?(b.done(a.return_value),f=!0):d.returnsValuesArray.length===d.length&&b.fail("Unable to retrieve list.",0))};d.execJobsFromStorageArray(g)},b.removeDocument=function(){var a={},c={status:"done"},e="key",f=!1,g=function(a){d.returnsValuesArray.push(a),f||(a.status!=="fail"?(b.done(),f=!0):d.returnsValuesArray.length===d.length&&b.fail("Unable to remove any file.",0))};d.execJobsFromStorageArray(g)},b},c.addStorageType("local",function(a){return new f(a)}),c.addStorageType("dav",function(a){return new g(a)}),c.addStorageType("replicate",function(a){return new h(a)})};window.requirejs?define("JIOStorages",["LocalOrCookieStorage","Base64","JIO","jQuery"],a):a(LocalOrCookieStorage,Base64,JIO,jQuery)})();